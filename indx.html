<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÜÿ∏ÿßŸÖ ÿ≠ÿ∂Ÿàÿ± - ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿØÿ±ÿ≥</title>
    <style>
        :root {
            --bg: #fdfdfd;
            --card: #fff;
            --accent: #0b5ed7;
            --muted: #555;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        body {
            font-family: "Tahoma", sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            direction: rtl;
            color: #111;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            text-align: center;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        input,
        select,
        button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            cursor: pointer
        }

        button.primary {
            background: var(--accent);
            color: #fff;
            border: none;
        }

        button.ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid rgba(11, 94, 215, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: center;
        }

        th {
            background: #f3f6f9;
        }

        .present {
            background: var(--success);
            color: #fff;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .absent {
            background: var(--danger);
            color: #fff;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .badge {
            padding: 4px 6px;
            border-radius: 6px;
            font-size: 12px;
        }

        .warning {
            background: var(--warning);
            color: #555;
        }

        .small {
            font-size: 13px;
            color: var(--muted);
        }

        .actions button {
            margin: 2px;
        }

        .popup {
            position: fixed;
            inset: 40px;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            overflow: auto;
            z-index: 9999;
        }

        .popup h3 {
            text-align: center;
            margin-top: 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ŸÜÿ∏ÿßŸÖ ÿ≠ÿ∂Ÿàÿ± ÿßŸÑÿ∑ŸÑÿßÿ®</h1>

        <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ∑ŸÑÿßÿ® -->
        <div class="card">
            <div style="display:flex;gap:10px;">
                <input id="studentName" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®">
                <button id="addStudentBtn" class="primary">ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ®</button>
            </div>
        </div>

        <!-- ÿßŸÑÿ≠ÿ∂Ÿàÿ± -->
        <div class="card">
            <div style="display:flex;gap:10px;align-items:center;">
                <input type="date" id="sessionDate">
                <button id="newSessionBtn" class="primary">ŸÅÿ™ÿ≠ ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©</button>
                <button id="exportBtn" class="ghost">ÿ™ÿµÿØŸäÿ± CSV</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                        <th>ÿ≠ÿßŸÑÿ© ÿßŸÑŸäŸàŸÖ</th>
                        <th>ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿßŸÑÿ∫Ÿäÿßÿ® ÿßŸÑÿ≥ÿßÿ®ŸÇ</th>
                        <th>ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                    </tr>
                </thead>
                <tbody id="studentsTbody"></tbody>
            </table>
        </div>

        <!-- ÿßŸÑŸÖŸÑÿÆÿµ -->
        <div class="card">
            <div id="summary" class="small"></div>
        </div>
    </div>

    <script>

        const KEY_STUDENTS = 'att_students';
        const KEY_RECORDS = 'att_records';

        let students = JSON.parse(localStorage.getItem(KEY_STUDENTS) || '[]');
        let records = JSON.parse(localStorage.getItem(KEY_RECORDS) || '{}');

        const studentNameInput = document.getElementById('studentName');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const sessionDateInput = document.getElementById('sessionDate');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const studentsTbody = document.getElementById('studentsTbody');
        const summaryDiv = document.getElementById('summary');
        const exportBtn = document.getElementById('exportBtn');

        function saveData() {
            localStorage.setItem(KEY_STUDENTS, JSON.stringify(students));
            localStorage.setItem(KEY_RECORDS, JSON.stringify(records));
        }

        function todayStr(d = new Date()) {
            return d.toISOString().split('T')[0];
        }
        if (!sessionDateInput.value) sessionDateInput.value = todayStr();

        function addStudent() {
            const name = studentNameInput.value.trim();
            if (!name) return alert('ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®');
            const id = 's' + Date.now();
            students.push({ id, name });

            Object.keys(records).forEach(d => {
                if (!records[d]) records[d] = {};
                records[d][id] = 'absent';
            });

            saveData();
            studentNameInput.value = '';
            render();
        }

        function toggleAttendance(id, date) {
            if (!records[date]) records[date] = {};
            records[date][id] = records[date][id] === 'present' ? 'absent' : 'present';
            saveData();
            render();
        }

        function findPrevDate(date) {
            const dates = Object.keys(records).sort((a, b) => new Date(a) - new Date(b));
            for (let i = dates.length - 1; i >= 0; i--) {
                if (new Date(dates[i]) < new Date(date)) return dates[i];
            }
            return null;
        }

        function openNewSession(date) {
            if (!records[date]) records[date] = {};
            students.forEach(s => {
                if (!records[date][s.id]) records[date][s.id] = 'absent';
            });
            saveData();
            render();
        }

        function showHistory(id) {
            const student = students.find(s => s.id === id);
            if (!student) return alert('ÿßŸÑÿ∑ÿßŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');

            let rows = '';
            const dates = Object.keys(records).sort((a, b) => new Date(a) - new Date(b));

            dates.forEach(d => {
                if (records[d][id] !== undefined) {
                    const state = records[d][id];
                    rows += `<tr><td>${d}</td><td>${state === 'present' ? 'ÿ≠ÿßÿ∂ÿ±' : 'ÿ∫ÿßÿ¶ÿ®'}</td></tr>`;
                }
            });

            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <h3>ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ÿßŸÑÿ®: ${student.name}</h3>
                <table style="width:100%;border-collapse:collapse;">
                    <thead><tr><th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th><th>ÿßŸÑÿ≠ÿßŸÑÿ©</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div style="text-align:center;margin-top:10px;">
                    <button onclick="this.closest('.popup').remove()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        /* ---------------------------
            üî• ÿØÿßŸÑÿ© ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ÿßŸÑÿ® ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
           --------------------------- */

        function deleteStudent(id) {
            if (!confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ÿßŸÑÿ® Ÿàÿ¨ŸÖŸäÿπ ÿ≥ÿ¨ŸÑÿßÿ™Ÿá ŸÜŸáÿßÿ¶ŸäŸãÿßÿü")) return;

            students = students.filter(s => s.id !== id);

            Object.keys(records).forEach(date => {
                if (records[date][id] !== undefined) {
                    delete records[date][id];
                }
            });

            saveData();
            render();
            function showHistory(id) {


    const student = students.find(s => s.id === id);

    if (!student) return alert("ÿßŸÑÿ∑ÿßŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ");


    let rows = "";
    const dates = Object.keys(records).sort((a, b) => new Date(a) - new Date(b));

    dates.forEach(d => {
        const state = records[d][id];
        if (state !== undefined) {
            rows += `
                <tr>
                    <td>${d}</td>
                    <td>${state === "present" ? "ÿ≠ÿßÿ∂ÿ±" : "ÿ∫ÿßÿ¶ÿ®"}</td>
                </tr>
            `;
        }
    });

    const popup = document.createElement("div");
    popup.className = "popup";

    popup.innerHTML = `
        <h3>ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ÿßŸÑÿ®: ${student.name}</h3>
        <table style="width:100%;border-collapse:collapse;">
            <thead>
                <tr>
                    <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                    <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
        <div style="text-align:center;margin-top:10px;">
            <button onclick="this.closest('.popup').remove()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
        </div>
    `;

    document.body.appendChild(popup);
}
function showHistory(id) {
    const student = students.find(s => s.id === id);
    if (!student) return alert("ÿßŸÑÿ∑ÿßŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ");

    let rows = "";
    const dates = Object.keys(records).sort((a, b) => new Date(a) - new Date(b));

    dates.forEach(d => {
        const state = records[d][id];
        if (state !== undefined) {
            rows += `
                <tr>
                    <td>${d}</td>
                    <td>${state === "present" ? "ÿ≠ÿßÿ∂ÿ±" : "ÿ∫ÿßÿ¶ÿ®"}</td>
                </tr>
            `;
        }
    });

    const popup = document.createElement("div");
    popup.className = "popup";

}
        }

        function render() {
            studentsTbody.innerHTML = '';
            const date = sessionDateInput.value;
            const prevDate = findPrevDate(date);

            let presentCount = 0, absentCount = 0;

            students.forEach(s => {
                if (!records[date]) records[date] = {};
                if (!records[date][s.id]) records[date][s.id] = 'absent';

                const state = records[date][s.id];
                if (state === 'present') presentCount++; else absentCount++;

                let note = '-';
                if (prevDate && records[prevDate][s.id] === 'absent') {
                    note = `ÿ∫ÿßÿ® ŸÅŸä (${prevDate})`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.name}</td>
                    <td><span class="${state === 'present' ? 'present' : 'absent'}">${state === 'present' ? 'ÿ≠ÿßÿ∂ÿ±' : 'ÿ∫ÿßÿ¶ÿ®'}</span></td>
                    <td><span class="badge ${note.includes('ÿ∫ÿßÿ®') ? 'warning' : ''}">${note}</span></td>
                    <td class="actions">
                        <button onclick="toggleAttendance('${s.id}','${date}')">${state === 'present' ? 'ÿßÿ¨ÿπŸÑ ÿ∫ÿßÿ¶ÿ®' : 'ÿßÿ¨ÿπŸÑ ÿ≠ÿßÿ∂ÿ±'}</button>
                        <button onclick="showHistory('${s.id}')">ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ÿßŸÑÿ®</button>
                        <button style="color:red" onclick="deleteStudent('${s.id}')">ÿ≠ÿ∞ŸÅ</button>
                    </td>
                `;
                studentsTbody.appendChild(tr);
            });

            summaryDiv.innerHTML = `ÿ•ÿ¨ŸÖÿßŸÑŸä: ${students.length} ‚Äî ÿ≠ÿßÿ∂ÿ±: ${presentCount} ‚Äî ÿ∫ÿßÿ¶ÿ®: ${absentCount}`;
        }

        function exportCSV() {
            let csv = 'ÿßŸÑÿßÿ≥ŸÖ,ÿßŸÑÿ™ÿßÿ±ŸäÿÆ,ÿßŸÑÿ≠ÿßŸÑÿ©\n';
            students.forEach(s => {
                Object.keys(records).sort((a, b) => new Date(a) - new Date(b)).forEach(d => {
                    const state = records[d][s.id] || 'absent';
                    csv += `${s.name},${d},${state === 'present' ? 'ÿ≠ÿßÿ∂ÿ±' : 'ÿ∫ÿßÿ¶ÿ®'}\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'attendance.csv';
            a.click();
        }

        addStudentBtn.onclick = addStudent;
        newSessionBtn.onclick = () => openNewSession(sessionDateInput.value);
        exportBtn.onclick = exportCSV;

        if (!records[sessionDateInput.value]) openNewSession(sessionDateInput.value);
        render();

    </script>

</body>

</html>